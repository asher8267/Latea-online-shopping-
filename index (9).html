require("dotenv").config();
const express = require("express");
const mongoose = require("mongoose");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");
const cors = require("cors");
const path = require("path");

const app = express();
app.use(express.json());
app.use(cors());

// Serve frontend files
app.use(express.static(path.join(__dirname, "../frontend")));
app.use(express.static(path.join(__dirname, "public"))); // dashboard

/* =========================
   DATABASE CONNECTION
========================= */
mongoose.connect(process.env.MONGO_URI)
.then(() => console.log("MongoDB Connected"))
.catch(err => console.log(err));

/* =========================
   MODELS
========================= */
const UserSchema = new mongoose.Schema({ email: String, password: String });
const ProductSchema = new mongoose.Schema({ name: String, price: Number, image: String });
const CartSchema = new mongoose.Schema({ userId: String, items: [{ productId: String, quantity: Number }] });
const OrderSchema = new mongoose.Schema({ userId: String, items: Array, total: Number, createdAt: { type: Date, default: Date.now } });

const User = mongoose.model("User", UserSchema);
const Product = mongoose.model("Product", ProductSchema);
const Cart = mongoose.model("Cart", CartSchema);
const Order = mongoose.model("Order", OrderSchema);

/* =========================
   AUTH MIDDLEWARE
========================= */
function auth(req,res,next){
  const token=req.header("Authorization");
  if(!token) return res.status(401).json({message:"No token"});
  try{
    const verified = jwt.verify(token, process.env.JWT_SECRET);
    req.user=verified;
    next();
  }catch{
    res.status(400).json({message:"Invalid token"});
  }
}

/* =========================
   USER ROUTES
========================= */
app.post("/api/register", async (req,res)=>{
  const {email,password}=req.body;
  const hashed = await bcrypt.hash(password,10);
  const user = new User({email,password:hashed});
  await user.save();
  res.json({message:"User Registered"});
});

app.post("/api/login", async (req,res)=>{
  const {email,password}=req.body;
  const user = await User.findOne({email});
  if(!user) return res.status(400).json({message:"User not found"});
  const valid = await bcrypt.compare(password,user.password);
  if(!valid) return res.status(400).json({message:"Wrong password"});
  const token = jwt.sign({id:user._id},process.env.JWT_SECRET);
  res.json({token});
});

// Admin route for users
app.get('/api/users', async (req,res)=>{
  const users = await User.find({}, {email:1});
  res.json(users);
});

/* =========================
   PRODUCT ROUTES
========================= */
app.get("/api/products", async (req,res)=>{
  const products = await Product.find();
  res.json(products);
});

app.post("/api/products", async (req,res)=>{
  const {name,price,image}=req.body;
  const p = new Product({name,price,image});
  await p.save();
  res.json({message:"Product added"});
});

app.delete("/api/products/:id", async (req,res)=>{
  await Product.findByIdAndDelete(req.params.id);
  res.json({message:"Product deleted"});
});

/* =========================
   CART ROUTES
========================= */
app.post("/api/cart/add", auth, async (req,res)=>{
  const {productId,quantity}=req.body;
  let cart = await Cart.findOne({userId:req.user.id});
  if(!cart) cart = new Cart({userId:req.user.id,items:[]});
  const existing = cart.items.find(i=>i.productId===productId);
  if(existing) existing.quantity += quantity;
  else cart.items.push({productId,quantity});
  await cart.save();
  res.json({message:"Added to cart",cart});
});

app.post("/api/cart/remove", auth, async (req,res)=>{
  const {productId}=req.body;
  const cart = await Cart.findOne({userId:req.user.id});
  if(!cart) return res.status(400).json({message:"Cart empty"});
  cart.items = cart.items.filter(i=>i.productId!==productId);
  await cart.save();
  res.json({message:"Removed from cart",cart});
});

app.get("/api/cart", auth, async (req,res)=>{
  const cart = await Cart.findOne({userId:req.user.id});
  res.json(cart);
});

/* =========================
   ORDER ROUTES
========================= */
app.post("/api/order", auth, async (req,res)=>{
  const cart = await Cart.findOne({userId:req.user.id});
  if(!cart) return res.status(400).json({message:"Cart empty"});
  const products = await Product.find();
  let total = 0;
  cart.items.forEach(item=>{
    const product = products.find(p=>p.id===item.productId);
    if(product) total += product.price*item.quantity;
  });
  const order = new Order({userId:req.user.id,items:cart.items,total});
  await order.save();
  await Cart.deleteOne({userId:req.user.id});
  res.json({message:"Order placed",order});
});

app.get('/api/orders', async (req,res)=>{
  const orders = await Order.find();
  res.json(orders);
});

app.post('/api/orders/:id/complete', async (req,res)=>{
  res.json({message:'Order '+req.params.id+' marked complete'});
});

/* =========================
   DASHBOARD AND ROOT
========================= */
app.get("/", (req,res)=>{
  res.sendFile(path.join(__dirname,"../frontend/index.html"));
});

const PORT=5000;
app.listen(PORT,()=>console.log("Server running on port "+PORT));